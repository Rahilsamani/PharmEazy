@model List<PharmEazy.Models.DTO.CartItemDTO>

@{
	double totalPrice = Model.Sum(c => c.Price * c.Quantity);
}

<section class="h-100 h-custom">
	<div class="container py-5 h-100">
		<div class="row d-flex justify-content-center align-items-center h-100">
			<div class="col">
				<div class="card">
					<div class="card-body p-4">

						<div class="row">

							<div class="col-lg-12">
								<h5 class="mb-3">
									<a asp-action="Index" asp-controller="Home" class="text-body">
										<i class="fas fa-long-arrow-alt-left me-2"></i>Continue shopping
									</a>
								</h5>
								<hr>

								<div class="d-flex justify-content-between align-items-center mb-4">
									<div>
										<p class="mb-1">Shopping cart</p>
										<p class="mb-0">You have <span id="cart-item-count">@Model.Count</span> items in your cart</p>
									</div>
								</div>

								<table id="cartTable" class="table">
									<thead>
										<tr>
											<th>
												@Html.DisplayNameFor(model => model[0].ImageUrl)
											</th>
											<th>
												@Html.DisplayNameFor(model => model[0].Name)
											</th>
											<th>
												@Html.DisplayNameFor(model => model[0].Description)
											</th>
											<th>
												@Html.DisplayNameFor(model => model[0].ExpiryDate)
											</th>
											<th>
												@Html.DisplayNameFor(model => model[0].Quantity)
											</th>
											<th>
												@Html.DisplayNameFor(model => model[0].Price)
											</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody id="cartContainer">
									</tbody>
								</table>
							</div>

						</div>
					</div>
					@if (Model.Count > 0)
					{
						<div class="d-flex justify-content-center align-items-center mb-5 gap-4" id="buyAllProducts">
							<div class="fs-5">
								<strong>Total</strong>₹ <span id="totalCartPrice">@totalPrice</span>
							</div>
							<div id="buyAllItems" class="btn btn-success">
								Place Order
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	</div>

</section>


@section Scripts {
	<script>
		var url;
		var redirectUrl;
		var target;
		var items = 0;
		var totalAmount = 0;
		var cartData = "";

		LoadData();

		function LoadData() {
			$("#cartContainer").empty();

			$.ajax({
				type: 'Get',
				url: "@Url.Action("GetAllCartItems")",
				dataType: 'json',
				success: function (data) {
					totalAmount = data.totalAmount;
					items = data.items;

					$("#cart-item-count").text(items);
					$("#totalCartPrice").text(totalAmount);

					if(items<1){
						$("#buyAllProducts").empty();
					}

					cartData = data.cartItems;

					if(cartData.length==0){
						$('#cartTable').hide();
					}else{
						$('#cartTable').show();
					}

					$.each(data.cartItems, function (i, item) {

					var rows = `
						<tr >
							<td>
								<img src="/Images/${item.imageUrl}" class="img-fluid rounded-3" alt="Shopping item" style="width: 65px;">
							</td>
							<td>
								${item.name}
							</td>
							<td>
								${item.description}
							</td>
							<td>
								${item.expiryDate.substring(0,10)}
							</td>
							<td>
								${item.quantity}
							</td>
							<td>
								₹ ${item.price}
							</td>
							<td>
								<a class="btn btn-danger deleteCart"
									data-id="${item.id}"
									data-controller="Cart"
									data-action="Delete"
									data-body-message="Are you sure to remove from Cart?">Remove</a>
							</td>
						</tr>
					`;

					$('#cartContainer').append(rows);
					});
				},
			});
		}


		$('body').append(`
			<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title" id="myModalLabel">Warning</h4>
						</div>
						<div class="modal-body delete-modal-body">
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal" id="cancel-delete">Cancel</button>
							<button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
						</div>
					</div>
				</div>
			</div>`);

		//Delete Action
		$("body").on('click', '.deleteCart', (e) => {
			e.preventDefault();

			target = e.target;
			var Id = $(target).data('id');
			var controller = $(target).data('controller');
			var action = $(target).data('action');
			var bodyMessage = $(target).data('body-message');

			url = "/" + controller + "/" + action + "/" + Id;
			$(".delete-modal-body").text(bodyMessage);
			$("#deleteModal").modal('show');
		});


		$("#confirm-delete").on('click', () => {
			$.post(url)
				.done((result) => {
					notyf.dismissAll();
					if(result.success=true){
						notyf.success(result.message);
					}else{
						notyf.error(result.message);
					}
					LoadData();
				})
				.always(() => {
					$("#deleteModal").modal('hide');
				});
		});

		$("#cancel-delete").on('click', () => {
			$("#deleteModal").modal('hide');
		});

		$("#buyAllItems").on("click", function(){
			$.ajax({
				url: '@Url.Action("BuyAllCartItems")',
				contentType: 'application/json; charset=utf-8',
				data: JSON.stringify(cartData),
				type: 'POST',
				success: function(result){
					notyf.dismissAll();
					if(result.success==true){
						notyf.success(result.message);
						LoadData();
					}else{
						notyf.error(result.message);
					}
				}
			})
		})
	</script>
}




